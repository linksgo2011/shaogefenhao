(window.webpackJsonp=window.webpackJsonp||[]).push([[193],{1e3:function(s,t,e){"use strict";e.r(t);var n=e(15),a=Object(n.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("Docker存储使用的aufs文件系统分层存储结构,将容器文件以读写分层的形式存储在宿主机中。自带的镜像仓库删除比较麻烦，需要调用 API 删除，然后进入容器执行。")]),s._v(" "),e("h2",{attrs:{id:"手动删除"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动删除"}},[s._v("#")]),s._v(" 手动删除")]),s._v(" "),e("p",[s._v("进入 registry 容器")]),s._v(" "),e("blockquote",[e("p",[s._v("vim /etc/docker/registry/config.yml")])]),s._v(" "),e("p",[s._v("添加配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("storage:\n  delete:\n    enabled: true\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("重启 registry")]),s._v(" "),e("p",[s._v("调用 API 获取所有镜像仓库")]),s._v(" "),e("blockquote",[e("p",[s._v("curl http://host:5000/v2/_catalog")])]),s._v(" "),e("p",[s._v("获取仓库标签")]),s._v(" "),e("blockquote",[e("p",[s._v("curl http://host:5000/v2/app-frontend/tags/list")])]),s._v(" "),e("p",[s._v("获取标签对应的digest")]),s._v(" "),e("blockquote",[e("p",[s._v("curl http://host:5000/v2/app-frontend/manifests/v1")])]),s._v(" "),e("p",[s._v("注意： 必须配置 Header Accept: application/vnd.docker.distribution.manifest.v2+json，否则获取的值不对")]),s._v(" "),e("p",[s._v("注意看前面操作返回值的 Header，使用 Docker-Content-Digest 的完整值，包含 sha256: 前缀。")]),s._v(" "),e("p",[s._v("删除 manifest")]),s._v(" "),e("blockquote",[e("p",[s._v("curl http://host:5000/v2/app-frontend/manifests/sha256:1234455 -X DELETE")])]),s._v(" "),e("p",[s._v("调用API清理后，进入容器，清理磁盘空间")]),s._v(" "),e("p",[s._v("清理空间")]),s._v(" "),e("blockquote",[e("p",[s._v("registry garbage-collect /etc/docker/registry/config.yml")])]),s._v(" "),e("h2",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),e("blockquote",[e("p",[s._v("参考 API https://docs.docker.com/registry/spec/api\n单个清理过程 https://blog.csdn.net/isea533/article/details/87622213\n批量清理 https://blog.csdn.net/ywq935/article/details/83828888")])]),s._v(" "),e("h2",{attrs:{id:"网友编写的自动调api的-python2-7-脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#网友编写的自动调api的-python2-7-脚本"}},[s._v("#")]),s._v(" 网友编写的自动调API的 python2.7 脚本")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import requests\nfrom concurrent.futures import ThreadPoolExecutor\n\nclass Docker(object):\n    def __init__(self, hub, repos):\n        self.hub = hub\n        self.repos = repos\n\n    @staticmethod\n    def get_tag_list(hub, repo):\n        # 获取这个repo的所有tags\n        tag_list_url = '%s/v2/%s/tags/list' % (hub, repo)\n        r1 = requests.get(url=tag_list_url)\n        tag_list = r1.json().get('tags')\n        return tag_list\n\n    def main(self):\n        thpool = ThreadPoolExecutor(10)\n        for repo in self.repos:\n            thpool.submit(self.delete_images, repo)\n\n        thpool.shutdown(wait=True)\n\n    def delete_images(self, repo):\n        hub = self.hub\n        tag_list = self.get_tag_list(hub=hub, repo=repo)\n        num = 0\n        try:\n            # 保留最后两个版本的镜像\n            for tag in tag_list[:-2]:\n                # 获取image digest摘要信息\n                get_info_url = '{}/v2/{}/manifests/{}'.format(hub, repo, tag)\n                header = {\"Accept\": \"application/vnd.docker.distribution.manifest.v2+json\"}\n                r2 = requests.get(url=get_info_url, headers=header, timeout=10)\n                digest = r2.headers.get('Docker-Content-Digest')\n\n                # 删除镜像\n                delete_url = '%s/v2/%s/manifests/%s' % (hub, repo, digest)\n                r3 = requests.delete(url=delete_url)\n                if r3.status_code == 202:\n                    num += 1\n\n        except Exception as e:\n            print(str(e))\n\n        print('仓库%s 共删除了%i个历史镜像' % (repo, num))\n\n\nif __name__ == '__main__':\n    hub = 'http://registry.xxx.com:5000'\n    repos = ['zdtest', 'ordertest', 'bjdev', 'zhqtest', 'systemtest', 'zddev', 'bjtest', 'dsystemtest', 'tooltest']\n    d = Docker(hub=hub, repos=repos)\n    d.main()\n————————————————\n版权声明：本文为CSDN博主「ywq935」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。\n原文链接：https://blog.csdn.net/ywq935/article/details/83828888\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br")])])])}),[],!1,null,null,null);t.default=a.exports}}]);